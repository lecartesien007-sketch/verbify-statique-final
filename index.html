<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verbify Pro - FCGE</title>
    <!-- Chargement Tailwind CSS (pour le style) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement React et ReactDOM (Moteurs de l'application) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Chargement Babel (pour transformer le code React en JavaScript simple) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chargement Firebase (Database et Auth) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, memo } = React;
        const { initializeApp } = firebase.app;
        const { getAuth, signInAnonymously, onAuthStateChanged } = firebase.auth;
        const { getDatabase, ref, get, set, onValue, update, query, orderByChild, limitToLast } = firebase.database;

        const firebaseConfig = {
            apiKey: "AIzaSyCZQXRtEITaC7X5YJPH-VvfDuhzZYi1sSI",
            authDomain: "verbufy-by-bechir.firebaseapp.com",
            projectId: "verbufy-by-bechir",
            storageBucket: "verbufy-by-bechir.firebasestorage.app",
            messagingSenderId: "145432541455",
            appId: "1:145432541455:web:ba2ec858abc1619e48e67a",
            databaseURL: "https://verbufy-by-bechir-default-rtdb.firebaseio.com"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            // LIGNE CORRIG√âE : L'ancienne ligne (firebase.database().setLogLevel) a √©t√© SUPPRIM√âE.
        } catch (e) {
            console.error("Erreur d'initialisation de Firebase:", e);
        }

        const VERB_LIST = [
            { base: "be", past: "was/were", part: "been", fr: "√™tre" },
            { base: "have", past: "had", part: "had", fr: "avoir" },
            { base: "do", past: "did", part: "done", fr: "faire" },
            { base: "say", past: "said", part: "said", fr: "dire" },
            { base: "go", past: "went", part: "gone", fr: "aller" },
            { base: "get", past: "got", part: "got/gotten", fr: "obtenir" },
            { base: "make", past: "made", part: "made", fr: "faire/fabriquer" },
            { base: "know", past: "knew", part: "known", fr: "savoir" },
            { base: "think", past: "thought", part: "thought", fr: "penser" },
            { base: "take", past: "took", part: "taken", fr: "prendre" },
            { base: "see", past: "saw", part: "seen", fr: "voir" },
            { base: "come", past: "came", part: "come", fr: "venir" },
            { base: "want", past: "wanted", part: "wanted", fr: "vouloir" },
            { base: "look", past: "looked", part: "looked", fr: "regarder" },
            { base: "use", past: "used", part: "used", fr: "utiliser" },
            { base: "find", past: "found", part: "found", fr: "trouver" },
            { base: "give", past: "gave", part: "given", fr: "donner" },
            { base: "tell", past: "told", part: "told", fr: "dire (raconter)" },
            { base: "work", past: "worked", part: "worked", fr: "travailler" },
            { base: "call", past: "called", part: "called", fr: "appeler" },
        ];

        const PHRASAL_VERBS = [
            { base: "look for", fr: "chercher", ex: "I'm looking for my keys." },
            { base: "get up", fr: "se lever", ex: "He gets up at 6 AM." },
            { base: "turn on", fr: "allumer", ex: "Please turn on the light." },
            { base: "turn off", fr: "√©teindre", ex: "Turn off the TV." },
            { base: "give up", fr: "abandonner", ex: "Don't give up!" },
            { base: "put on", fr: "mettre (v√™tement)", ex: "Put on your coat." },
        ];

        const FINANCE_VERBS = [
            { base: "audit", fr: "auditer", ex: "The firm will audit our accounts." },
            { base: "leverage", fr: "utiliser un effet de levier", ex: "They leveraged their assets to buy the company." },
            { base: "hedge", fr: "couvrir (un risque)", ex: "He hedged his bets by investing in gold." },
            { base: "underwrite", fr: "souscrire / garantir", ex: "The bank agreed to underwrite the new share issue." },
            { base: "allocate", fr: "allouer", ex: "We need to allocate more resources to this project." },
            { base: "amortize", fr: "amortir", ex: "The loan will be amortized over 10 years." },
            { base: "invest", fr: "investir", ex: "She invests 20% of her salary." },
            { base: "liquidate", fr: "liquider", ex: "They had to liquidate their assets." },
            { base: "yield", past: "yielded", part: "yielded", fr: "rapporter / c√©der" },
            { base: "forecast", past: "forecast", part: "forecast", fr: "pr√©voir" },
        ];

        const createQuizQuestion = (verb) => {
            const type = Math.random() < 0.5 ? 'past' : 'part';
            const correct = type === 'past' ? verb.past.split('/')[0] : verb.part.split('/')[0];
            
            const allOptions = VERB_LIST.filter(v => v.base !== verb.base)
                                        .sort(() => 0.5 - Math.random())
                                        .slice(0, 3)
                                        .map(v => type === 'past' ? v.past.split('/')[0] : v.part.split('/')[0]);
            
            const options = [...allOptions, correct].sort(() => 0.5 - Math.random());

            return {
                verb,
                type,
                questionText: `Quelle est la forme au ${type === 'past' ? 'pr√©t√©rit' : 'participe pass√©'} de "${verb.base}" (${verb.fr})?`,
                options,
                correctAnswer: correct
            };
        };
        
        // --- COMPOSANTS UI DE BASE ---
        const Header = memo(({ userData }) => (
            <header className="p-5 rounded-b-3xl" style={{background: 'linear-gradient(135deg, #4F46E5 0%, #818CF8 100%)'}}>
              <div className="flex justify-between items-center mb-2">
                <div>
                  <h1 className="text-3xl font-bold text-white">Verbify</h1>
                  <p className="text-sm text-indigo-200 -mt-1">created by Kone Mohamed Bechir</p>
                </div>
                <div className="flex gap-4">
                  <div className="text-center">
                    <div className="text-2xl text-white font-bold">{userData.xp || 0}</div>
                    <div className="text-xs text-indigo-200">‚≠êÔ∏è XP</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl text-white font-bold">{userData.streak || 0}</div>
                    <div className="text-xs text-indigo-200">üî• S√©rie</div>
                  </div>
                </div>
              </div>
            </header>
        ));

        const BottomNavBar = memo(({ currentScreen, setCurrentScreen }) => {
            const navItems = [
                { id: 'lecon', label: 'Le√ßon', icon: 'üéì' },
                { id: 'progres', label: 'Progr√®s', icon: 'üìä' },
                { id: 'jeux', label: 'Jeux', icon: 'üéÆ' },
                { id: 'dico', label: 'Dico', icon: 'üìö' },
                { id: 'finance', label: 'Finance', icon: 'üìà' },
                { id: 'social', label: 'Social', icon: 'üèÜ' },
            ];

            return (
                <nav className="fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto bg-white border-t border-gray-200 shadow-inner flex justify-around p-2">
                    {navItems.map(item => (
                        <button
                            key={item.id}
                            onClick={() => setCurrentScreen(item.id)}
                            className={`flex flex-col items-center p-2 rounded-lg transition-all ${
                                currentScreen === item.id ? 'bg-indigo-100 text-indigo-600' : 'text-gray-500 hover:text-indigo-500'
                            }`}
                        >
                            <span className="text-2xl">{item.icon}</span>
                            <span className="text-xs font-medium">{item.label}</span>
                        </button>
                    ))}
                </nav>
            );
        });

        const LoadingScreen = ({ message }) => (
            <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4 text-center">
                <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mb-4"></div>
                <h1 className="text-2xl font-bold text-indigo-700">Verbify</h1>
                <p className="text-gray-600 mt-2">{message}</p>
            </div>
        );

        // --- √âCRAN DE CONNEXION (LOGIN) ---
        function LoginScreen({ userId }) {
            const [name, setName] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            const saveName = async () => {
                if (name.length < 2) {
                    setError("Veuillez entrer un nom d'au moins 2 caract√®res.");
                    return;
                }
                setIsLoading(true);
                setError(null);
                try {
                    const userRef = ref(db, `users/${userId}`);
                    await update(userRef, { name: name });
                } catch (err) {
                    console.error("Erreur saveName:", err);
                    setError("Impossible d'enregistrer le nom. R√©essayez.");
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4" style={{background: 'linear-gradient(135deg, #4F46E5 0%, #818CF8 100%)'}}>
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
                        <div className="text-6xl mb-4">ü§ñ</div>
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">Bienvenue, √©l√®ves de la FCGE !</h1>
                        <p className="text-base text-gray-600 mb-6">(Finance Compta Gestion d'Entreprise)</p>
                        
                        <p className="text-lg text-gray-700 mb-4">Comment devrions-nous vous appeler ?</p>
                        <input
                            type="text"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="Entrez votre nom..."
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                        <button
                            onClick={saveName}
                            disabled={isLoading}
                            className="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-bold text-lg mt-6 hover:bg-indigo-700 transition-transform transform hover:scale-105 shadow-lg disabled:bg-gray-400 disabled:hover:scale-100 flex items-center justify-center"
                        >
                            {isLoading ? (
                                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                            ) : (
                                "Start Adventure"
                            )}
                        </button>
                    </div>
                </div>
            );
        }

        // --- √âCRAN LE√áON ---
        const LessonScreen = memo(({ userData, userId, startQuiz }) => {
            const [dailyVerbs, setDailyVerbs] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            const getDailyVerbs = useCallback(async () => {
                setIsLoading(true);
                const today = new Date().toDateString();
                
                const lastCompletedDate = userData.lastCompleted ? new Date(userData.lastCompleted).toDateString() : null;
                if (lastCompletedDate === today) {
                    setDailyVerbs([]);
                    setIsLoading(false);
                    return;
                }

                if (userData.dailyVerbs && userData.dailyVerbs.length === 5) {
                    setDailyVerbs(userData.dailyVerbs.map(base => VERB_LIST.find(v => v.base === base)));
                    setIsLoading(false);
                    return;
                }

                const learnedBases = Object.keys(userData.progress || {});
                const unlearnedVerbs = VERB_LIST.filter(verb => !learnedBases.includes(verb.base));
                
                const newVerbs = unlearnedVerbs
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 5);

                if (newVerbs.length < 5) {
                    const allVerbsShuffled = [...VERB_LIST].sort(() => 0.5 - Math.random()).slice(0, 5);
                    setDailyVerbs(allVerbsShuffled);
                    await set(ref(db, `users/${userId}/dailyVerbs`), allVerbsShuffled.map(v => v.base));
                } else {
                    setDailyVerbs(newVerbs);
                    await set(ref(db, `users/${userId}/dailyVerbs`), newVerbs.map(v => v.base));
                }
                setIsLoading(false);
            }, [userData, userId]);

            useEffect(() => {
                getDailyVerbs();
            }, [getDailyVerbs]);

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h2 className="text-2xl font-bold mb-4">Votre le√ßon du jour</h2>
                        <p className="text-gray-600 mb-4">
                            Pr√™t pour votre le√ßon du jour ? N'oubliez pas de viser la s√©rie !
                        </p>
                        
                        {isLoading && <p className="text-gray-500">Chargement des verbes...</p>}
                        
                        {!isLoading && dailyVerbs.length === 0 && (
                            <div className="bg-green-100 p-4 rounded-lg">
                                <h3 className="text-xl font-bold text-green-700">Le√ßon termin√©e ! üéâ</h3>
                                <p className="text-green-600">Excellent travail. Revenez demain pour 5 nouveaux verbes !</p>
                            </div>
                        )}

                        {!isLoading && dailyVerbs.length > 0 && (
                            <>
                                <p className="text-gray-600 mb-4">Pr√™t √† apprendre ces 5 nouveaux verbes ?</p>
                                <div className="flex flex-wrap gap-2 justify-center mb-6">
                                    {dailyVerbs.map(verb => (
                                        <span key={verb.base} className="bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full">
                                            {verb.base}
                                        </span>
                                    ))}
                                </div>
                                <button
                                    onClick={startQuiz}
                                    className="w-full bg-green-500 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-green-600 transition-transform transform hover:scale-105 shadow-md"
                                >
                                    Commencer le Quiz (+10 XP)
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        });

        // --- √âCRAN QUIZ ---
        function QuizScreen({ questions, onComplete, onBack }) {
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [showResults, setShowResults] = useState(false);

            const currentQuestion = questions[currentQuestionIndex];
            const [selectedAnswer, setSelectedAnswer] = useState(null);

            const handleAnswer = (answer) => {
                if (feedback) return;

                const isCorrect = answer === currentQuestion.correctAnswer;
                setSelectedAnswer(answer);

                if (isCorrect) {
                    setScore(s => s + 1);
                    setFeedback('‚úÖ Correct !');
                } else {
                    setFeedback(`‚ùå Faux. La bonne r√©ponse √©tait "${currentQuestion.correctAnswer}"`);
                }

                setTimeout(() => {
                    setFeedback(null);
                    setSelectedAnswer(null);
                    if (currentQuestionIndex < questions.length - 1) {
                        setCurrentQuestionIndex(i => i + 1);
                    } else {
                        setShowResults(true);
                    }
                }, 1500);
            };

            const handleResultsEffect = useCallback(() => {
                if (showResults) {
                    const xpGained = score >= 3 ? 10 : 0;
                    if (score >= 3) {
                        onComplete(xpGained);
                    } else {
                        onBack();
                    }
                }
            }, [showResults, score, onComplete, onBack]);

            useEffect(() => {
                handleResultsEffect();
            }, [handleResultsEffect]);


            if (showResults) {
                const xpGained = score >= 3 ? 10 : 0;
                const resultMessage = score >= 3 ? "Super ! Vous avez r√©ussi le quiz et gagnez 10 XP." : "Oups. Entra√Ænez-vous encore et revenez demain. (0 XP)";
                
                return (
                    <div className="bg-white p-6 rounded-2xl shadow-lg text-center">
                        <h2 className="text-3xl font-bold mb-4">{score >= 3 ? "Bravo !" : "Entra√Ænez-vous !"}</h2>
                        <p className="text-xl mb-4">Votre score : {score} / {questions.length}</p>
                        <p className={`text-lg font-semibold ${score >= 3 ? 'text-green-600' : 'text-red-600'}`}>{resultMessage}</p>
                        <button onClick={onBack} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">
                            Retour √† l'accueil
                        </button>
                    </div>
                );
            }
            
            if (!currentQuestion) return <LoadingScreen message="Pr√©paration du quiz..." />;

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg">
                    <button onClick={onBack} className="text-indigo-600 mb-4 text-lg">&larr; Quitter le Quiz</button>
                    <div className="text-center">
                        <p className="text-sm text-gray-500 mb-2">Question {currentQuestionIndex + 1} / {questions.length}</p>
                        <div className="bg-indigo-50 p-6 rounded-xl mb-6">
                            <h3 className="text-xl font-semibold text-indigo-800">{currentQuestion.questionText}</h3>
                        </div>
                        
                        {currentQuestion.options.map((option, index) => (
                            <button
                                key={index}
                                onClick={() => handleAnswer(option)}
                                disabled={!!feedback}
                                className={`w-full py-3 px-4 mb-3 rounded-lg font-medium text-lg border-2 transition-all ${
                                    feedback && option === currentQuestion.correctAnswer
                                        ? 'bg-green-500 text-white border-green-700 shadow-md'
                                        : feedback && option === selectedAnswer && option !== currentQuestion.correctAnswer
                                        ? 'bg-red-500 text-white border-red-700 shadow-md'
                                        : 'bg-gray-100 border-gray-300 hover:bg-gray-200 text-gray-800'
                                }`}
                            >
                                {option}
                            </button>
                        ))}
                        
                        {feedback && (
                            <p className={`mt-4 text-xl font-bold ${feedback.startsWith('‚úÖ') ? 'text-green-600' : 'text-red-600'}`}>
                                {feedback}
                            </p>
                        )}
                    </div>
                </div>
            );
        }

        // --- √âCRAN PROGR√àS (CALENDRIER) ---
        const ProgressScreen = memo(({ userData }) => {
            const [currentDate] = useState(new Date());

            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const emptyDays = Array.from({ length: (firstDayOfMonth + 6) % 7 });

            const lastCompletedDate = userData.lastCompleted ? new Date(userData.lastCompleted).toDateString() : null;
            const today = new Date().toDateString();

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 className="text-2xl font-bold text-center mb-4">Mon Progr√®s</h2>
                    <div className="text-center mb-4">
                        <h3 className="text-xl font-semibold">{currentDate.toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}</h3>
                    </div>
                    <div className="grid grid-cols-7 gap-2 text-center">
                        {['Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa', 'Di'].map(day => (
                            <div key={day} className="font-bold text-gray-500 text-sm">{day}</div>
                        ))}
                        {emptyDays.map((_, i) => (
                            <div key={`empty-${i}`}></div>
                        ))}
                        {daysArray.map(day => {
                            const dateToCheck = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                            const isToday = dateToCheck.toDateString() === today;
                            const isCompleted = lastCompletedDate === dateToCheck.toDateString();
                            
                            let dayClass = "w-10 h-10 flex items-center justify-center rounded-full";
                            if (isCompleted || (isToday && lastCompletedDate === today)) {
                                dayClass += " bg-green-500 text-white font-bold";
                            } else if (isToday) {
                                dayClass += " bg-indigo-100 text-indigo-600 font-bold";
                            } else {
                                dayClass += " text-gray-700";
                            }
                            
                            return (
                                <div key={day} className={dayClass}>
                                    {day}
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-8 p-4 bg-indigo-50 rounded-lg text-center">
                        <p className="text-indigo-800 font-semibold">S√©rie de Jours Actuelle : {userData.streak || 0} üî•</p>
                    </div>
                </div>
            );
        });

        // --- √âCRAN JEUX ---
        const GameScreen = memo(() => {
            const [currentGame, setCurrentGame] = useState(null);

            const games = [
                { id: 'truefalse', label: 'Vrai ou Faux', icon: '‚ùì', description: 'Le pr√©t√©rit de "go" est "went" ?' },
                { id: 'writing', label: '√âcriture', icon: '‚úçÔ∏è', description: '√âcrivez les 3 formes du verbe.' },
                { id: 'test', label: 'Test de Vitesse', icon: '‚ö°Ô∏è', description: 'Bient√¥t disponible !' },
            ];

            if (currentGame) {
                if (currentGame === 'truefalse') return <GameTrueFalse onBack={() => setCurrentGame(null)} />;
                if (currentGame === 'writing') return <GameWriting onBack={() => setCurrentGame(null)} />;
            }

            return (
                <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-center mb-4">Mini-Jeux</h2>
                    {games.map(game => (
                        <button
                            key={game.id}
                            onClick={() => game.id !== 'test' ? setCurrentGame(game.id) : console.log('Jeu √† venir')}
                            disabled={game.id === 'test'}
                            className="w-full bg-white p-5 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:hover:scale-100"
                        >
                            <div className="text-4xl p-3 bg-gray-100 rounded-lg">{game.icon}</div>
                            <div>
                                <h3 className="text-xl font-bold text-gray-800">{game.label}</h3>
                                <p className="text-gray-500">{game.description}</p>
                            </div>
                        </button>
                    ))}
                </div>
            );
        });

        // --- Jeu 1 : Vrai ou Faux ---
        function GameTrueFalse({ onBack }) {
            const [question, setQuestion] = useState(null);
            const [score, setScore] = useState(0);

            const generateQuestion = useCallback(() => {
                const verb = VERB_LIST[Math.floor(Math.random() * VERB_LIST.length)];
                const isTrue = Math.random() > 0.5;
                let falsePast;
                if (!isTrue) {
                    falsePast = VERB_LIST[Math.floor(Math.random() * VERB_LIST.length)].past;
                    while (falsePast === verb.past) {
                        falsePast = VERB_LIST[Math.floor(Math.random() * VERB_LIST.length)].past;
                    }
                }
                setQuestion({
                    verb,
                    displayPast: isTrue ? verb.past : falsePast,
                    isTrue,
                });
            }, []);

            useEffect(generateQuestion, [generateQuestion]);

            const handleAnswer = (answer) => {
                if ((answer && question.isTrue) || (!answer && !question.isTrue)) {
                    setScore(s => s + 1);
                } else {
                    setScore(0);
                }
                generateQuestion();
            };

            if (!question) return <LoadingScreen message="Chargement du jeu..." />;

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg">
                    <button onClick={onBack} className="text-indigo-600 mb-4">&larr; Retour aux jeux</button>
                    <div className="text-center">
                        <h3 className="text-xl font-bold mb-2">Vrai ou Faux ?</h3>
                        <p className="text-lg text-gray-600 mb-6">Score actuel : {score}</p>
                        <div className="bg-gray-100 p-8 rounded-lg mb-6">
                            <p className="text-2xl">Le pr√©t√©rit de <strong className="text-indigo-600">{question.verb.base}</strong></p>
                            <p className="text-2xl">est</p>
                            <p className="text-4xl font-bold mt-2">{question.displayPast}</p>
                        </div>
                        <div className="flex justify-around">
                            <button onClick={() => handleAnswer(true)} className="bg-green-500 text-white font-bold py-3 px-10 rounded-lg text-xl hover:bg-green-600">Vrai</button>
                            <button onClick={() => handleAnswer(false)} className="bg-red-500 text-white font-bold py-3 px-10 rounded-lg text-xl hover:bg-red-600">Faux</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Jeu 2 : √âcriture ---
        function GameWriting({ onBack }) {
            const [verb, setVerb] = useState(null);
            const [past, setPast] = useState('');
            const [part, setPart] = useState('');
            const [message, setMessage] = useState('');
            const [score, setScore] = useState(0);

            const newVerb = useCallback(() => {
                setVerb(VERB_LIST[Math.floor(Math.random() * VERB_LIST.length)]);
                setPast('');
                setPart('');
                setMessage('');
            }, []);

            useEffect(newVerb, [newVerb]);

            const checkAnswer = () => {
                const isPastCorrect = verb.past.split('/').includes(past.trim().toLowerCase());
                const isPartCorrect = verb.part.split('/').includes(part.trim().toLowerCase());

                if (isPastCorrect && isPartCorrect) {
                    setMessage('Parfait ! Verbe suivant.');
                    setScore(s => s + 1);
                    setTimeout(newVerb, 1500);
                } else {
                    setMessage(`Oups ! ${!isPastCorrect ? 'Pr√©t√©rit ' : ''} ${!isPartCorrect ? 'Participe ' : ''} incorrect.`);
                }
            };

            if (!verb) return <LoadingScreen message="Chargement..." />;

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg">
                    <button onClick={onBack} className="text-indigo-600 mb-4">&larr; Retour aux jeux</button>
                    <div className="text-center">
                        <h3 className="text-xl font-bold mb-2">Jeu d'√âcriture</h3>
                        <p className="text-lg text-gray-600 mb-6">Score : {score}</p>
                        
                        <div className="bg-gray-100 p-8 rounded-lg mb-6">
                            <p className="text-2xl">√âcrivez les formes de :</p>
                            <p className="text-4xl font-bold mt-2 text-indigo-600">{verb.base} ({verb.fr})</p>
                        </div>
                        
                        <div className="space-y-4">
                            <input
                                type="text"
                                value={past}
                                onChange={(e) => setPast(e.target.value)}
                                placeholder="Pr√©t√©rit (ex: went)"
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <input
                                type="text"
                                value={part}
                                onChange={(e) => setPart(e.target.value)}
                                placeholder="Participe Pass√© (ex: gone)"
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                        </div>
                        
                        <button onClick={checkAnswer} className="w-full bg-green-500 text-white font-bold py-3 px-10 rounded-lg text-xl hover:bg-green-600 mt-6">
                            Valider
                        </button>
                        {message && <p className="text-lg mt-4">{message}</p>}
                    </div>
                </div>
            );
        }

        // --- √âCRAN DICTIONNAIRE ---
        const DictionaryScreen = memo(({ userData, userId }) => {
            const [tab, setTab] = useState('verbs');
            const [searchTerm, setSearchTerm] = useState('');
            const [apiResult, setApiResult] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            const favorites = useMemo(() => userData.favorites || {}, [userData.favorites]);

            const handleSearch = async (e) => {
                e.preventDefault();
                if (searchTerm.length < 2) return;
                
                setIsLoading(true);
                setApiResult(null);
                setError(null);
                
                // Simulation pour √©viter les erreurs CORS/API dans un HTML simple
                setTimeout(() => {
                    const verb = VERB_LIST.find(v => v.base === searchTerm.toLowerCase());
                    if (verb) {
                        setApiResult({
                            word: verb.base,
                            phonetics: [{ audio: null }],
                            meanings: [{
                                partOfSpeech: 'verb',
                                definitions: [{
                                    definition: verb.fr,
                                    example: `You must learn to ${verb.base} correctly.`
                                }]
                            }]
                        });
                        setError(null);
                    } else {
                         setError('Mot non trouv√© (Fonctionnalit√© API simul√©e).');
                    }
                    setIsLoading(false);
                }, 800);
            };

            const toggleFavorite = async (verbBase) => {
                const newFavorites = { ...favorites };
                if (newFavorites[verbBase]) {
                    delete newFavorites[verbBase];
                } else {
                    newFavorites[verbBase] = true;
                }
                await update(ref(db, `users/${userId}`), { favorites: newFavorites });
            };
            
            const playAudio = (audioUrl, word) => {
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                speechSynthesis.speak(utterance);
            };

            return (
                <div className="space-y-4">
                    <h2 className="text-2xl font-bold text-center mb-4">Dictionnaire</h2>
                    <div className="flex border-b">
                        <button onClick={() => setTab('verbs')} className={`flex-1 p-3 font-bold ${tab === 'verbs' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-500'}`}>
                            Verbes
                        </button>
                        <button onClick={() => setTab('phrasal')} className={`flex-1 p-3 font-bold ${tab === 'phrasal' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-500'}`}>
                            Verbes √† Particule
                        </button>
                    </div>

                    <form onSubmit={handleSearch} className="flex gap-2">
                        <input
                            type="text"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            placeholder="Rechercher un mot anglais..."
                            className="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                        <button type="submit" className="bg-indigo-600 text-white p-3 rounded-lg text-2xl">üîç</button>
                    </form>

                    {tab === 'verbs' && (
                        <div className="space-y-4">
                            {isLoading && <p>Recherche en cours...</p>}
                            {error && <p className="text-red-500">{error}</p>}
                            {apiResult && (
                                <div className="bg-white p-6 rounded-2xl shadow-lg">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="text-3xl font-bold">{apiResult.word}</h3>
                                        <button onClick={() => toggleFavorite(apiResult.word)} className="text-3xl">
                                            {favorites[apiResult.word] ? '‚≠êÔ∏è' : '‚òÜ'}
                                        </button>
                                    </div>
                                    <div className="flex items-center gap-2 mb-4">
                                        <button onClick={() => playAudio(null, apiResult.word)} className="text-2xl">üîä</button>
                                    </div>
                                    
                                    {apiResult.meanings.map((meaning, index) => (
                                        <div key={index} className="mt-4">
                                            <h4 className="text-xl font-semibold italic text-indigo-600">{meaning.partOfSpeech}</h4>
                                            {meaning.definitions.slice(0, 2).map((def, i) => (
                                                <div key={i} className="mt-2 pl-4 border-l-4 border-gray-200">
                                                    <p className="text-gray-700">{def.definition}</p>
                                                    {def.example && <p className="text-gray-500 italic mt-1">"{def.example}"</p>}
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                    <AiExampleGenerator word={apiResult.word} />
                                </div>
                            )}
                        </div>
                    )}

                    {tab === 'phrasal' && (
                        <div className="bg-white p-6 rounded-2xl shadow-lg space-y-4">
                            {PHRASAL_VERBS.filter(v => v.base.includes(searchTerm.toLowerCase())).map(verb => (
                                <div key={verb.base}>
                                    <h3 className="text-xl font-bold">{verb.base}</h3>
                                    <p className="text-gray-600">{verb.fr}</p>
                                    <p className="text-gray-500 italic">"{verb.ex}"</p>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        });

        // --- G√©n√©rateur d'exemples IA (Simul√©) ---
        function AiExampleGenerator({ word }) {
            const [examples, setExamples] = useState([]);
            const [isLoading, setIsLoading] = useState(false);

            const fetchExamples = async () => {
                setIsLoading(true);
                setExamples([]);
                
                const simulatedExamples = [
                    `The analyst must ${word} the financial statements by next Tuesday.`,
                    `We need to ${word} the data from the past quarter to predict growth.`,
                    `The manager ${word}s every new contract before signing it.`
                ];
                
                setTimeout(() => {
                    setExamples(simulatedExamples);
                    setIsLoading(false);
                }, 1500);
            };

            return (
                <div className="mt-6">
                    <button 
                        onClick={fetchExamples} 
                        disabled={isLoading}
                        className="flex items-center justify-center gap-2 w-full bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200"
                    >
                        {isLoading ? (
                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-700"></div>
                        ) : (
                            "‚ú® G√©n√©rer des exemples (Simul√©)"
                        )}
                    </button>
                    {examples.length > 0 && (
                        <ul className="list-disc list-inside mt-4 space-y-2">
                            {examples.map((ex, i) => <li key={i} className="text-gray-700 italic">{ex}</li>)}
                        </ul>
                    )}
                </div>
            );
        }

        // --- √âCRAN FINANCE (Simul√©) ---
        const FinanceScreen = memo(() => {
            const [question, setQuestion] = useState(null);
            const [answer, setAnswer] = useState('');
            const [feedback, setFeedback] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const generateDrill = async () => {
                setIsLoading(true);
                setFeedback('');
                setAnswer('');
                
                const verb = FINANCE_VERBS[Math.floor(Math.random() * FINANCE_VERBS.length)];
                
                setTimeout(() => {
                    setQuestion({ 
                        question: `The board decided to _______ their risk by investing in diverse portfolios.`, 
                        answer: "hedge",
                        fr: verb.fr 
                    });
                    setIsLoading(false);
                }, 1500);
            };
            
            const checkFinanceAnswer = () => {
                if (!question) return;
                const correctAnswer = question.answer.toLowerCase().trim();
                const userAnswer = answer.toLowerCase().trim();

                if (userAnswer === correctAnswer) {
                    setFeedback('Correct ! üéâ');
                } else {
                    setFeedback(`Oups ! La bonne r√©ponse √©tait "${correctAnswer}".`);
                }
            };

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg text-center">
                    <h2 className="text-2xl font-bold mb-4">AI-Drill : Finance üìà</h2>
                    <p className="text-gray-600 mb-6">Testez vos connaissances sur les verbes financiers (Action simul√©e).</p>
                    
                    <button onClick={generateDrill} disabled={isLoading} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 mb-6">
                        {isLoading ? "G√©n√©ration..." : "G√©n√©rer un test"}
                    </button>

                    {question && (
                        <div className="mt-4">
                            <p className="text-xl text-gray-700 mb-4">{question.question.replace('_______', '___')}</p>
                            <input
                                type="text"
                                value={answer}
                                onChange={(e) => setAnswer(e.target.value)}
                                placeholder={`Votre r√©ponse (${question.fr})...`}
                                className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <button onClick={checkFinanceAnswer} className="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 mt-4">
                                Valider
                            </button>
                            {feedback && <p className="text-lg mt-4">{feedback}</p>}
                        </div>
                    )}
                </div>
            );
        });

        // --- √âCRAN SOCIAL (CLASSEMENT) ---
        const LeaderboardScreen = memo(() => {
            const [leaderboard, setLeaderboard] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                if (!db) return;

                const usersRef = ref(db, 'users');
                const topUsersQuery = query(usersRef, orderByChild('xp'), limitToLast(10));

                const unsubscribe = onValue(topUsersQuery, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const sortedUsers = Object.values(data)
                            .sort((a, b) => b.xp - a.xp);
                        setLeaderboard(sortedUsers);
                    }
                    setIsLoading(false);
                }, (error) => {
                    console.error("Erreur classement:", error);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, []);

            return (
                <div className="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 className="text-2xl font-bold text-center mb-6">Classement üèÜ</h2>
                    {isLoading ? (
                        <p>Chargement du classement...</p>
                    ) : (
                        <ol className="space-y-4">
                            {leaderboard.map((user, index) => (
                                <li key={user.name + index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div className="flex items-center gap-3">
                                        <span className="text-lg font-bold w-6">
                                            {index === 0 && 'ü•á'}
                                            {index === 1 && 'ü•à'}
                                            {index === 2 && 'ü•â'}
                                            {index > 2 && `${index + 1}.`}
                                        </span>
                                        <span className="text-lg font-semibold">{user.name}</span>
                                    </div>
                                    <span className="text-lg font-bold text-indigo-600">{user.xp} XP</span>
                                </li>
                            ))}
                        </ol>
                    )}
                </div>
            );
        });


        // --- COMPOSANT PRINCIPAL (ROOT) ---
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loadingUser, setLoadingUser] = useState(true);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [appError, setAppError] = useState(null);
            const [currentScreen, setCurrentScreen] = useState('lecon');
            const [quizQuestions, setQuizQuestions] = useState([]);

            // 1. Authentification
            useEffect(() => {
                if (!auth) return;
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        await checkAndCreateUserData(currentUser.uid);
                        setIsAuthReady(true);
                    } else {
                        try {
                            signInAnonymously(auth);
                        } catch (error) {
                            console.error("Erreur de connexion anonyme:", error);
                            setAppError("Impossible de se connecter au service.");
                        }
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. Cr√©ation/V√©rification des donn√©es
            const checkAndCreateUserData = async (userId) => {
                const userRef = ref(db, `users/${userId}`);
                try {
                    const snapshot = await get(userRef);
                    if (!snapshot.exists()) {
                        const newUserData = {
                            name: "",
                            xp: 0,
                            streak: 0,
                            lastCompleted: null,
                            favorites: {},
                            dailyVerbs: [],
                            createdAt: new Date().toISOString(),
                        };
                        await set(userRef, newUserData);
                    }
                } catch (error) {
                    console.error("Erreur checkAndCreateUserData:", error);
                    setAppError("Impossible de cr√©er le profil utilisateur.");
                }
            };

            // 3. √âcoute des donn√©es
            useEffect(() => {
                if (!isAuthReady || !user) return;
                const userRef = ref(db, `users/${user.uid}`);
                const unsubscribe = onValue(userRef, (snapshot) => {
                    if (snapshot.exists()) {
                        setUserData(snapshot.val());
                    } else {
                        console.warn("Snapshot utilisateur inexistant.");
                    }
                    setLoadingUser(false);
                }, (error) => {
                    console.error("Erreur onValue (userData):", error);
                    setAppError("Impossible de synchroniser les donn√©es utilisateur.");
                    setLoadingUser(false);
                });
                return () => unsubscribe();
            }, [isAuthReady, user]);

            const startQuiz = useCallback(() => {
                if (userData.dailyVerbs && userData.dailyVerbs.length > 0) {
                    const verbs = userData.dailyVerbs.map(base => VERB_LIST.find(v => v.base === base));
                    const questions = verbs.map(v => createQuizQuestion(v));
                    setQuizQuestions(questions);
                    setCurrentScreen('quiz');
                }
            }, [userData]);

            const completeDailyLesson = async (xpGained) => {
                const today = new Date();
                const lastDate = userData.lastCompleted ? new Date(userData.lastCompleted) : null;
                let newStreak = userData.streak || 0;
                
                if (lastDate && lastDate.toDateString() === new Date(today.getTime() - 86400000).toDateString()) {
                    newStreak += 1;
                } else if (!lastDate || lastDate.toDateString() !== today.toDateString()) {
                    newStreak = 1;
                }

                const updates = {
                    xp: (userData.xp || 0) + xpGained,
                    streak: newStreak,
                    lastCompleted: today.toISOString(),
                    dailyVerbs: [],
                };
                
                await update(ref(db, `users/${user.uid}`), updates);
                setCurrentScreen('lecon');
            };

            // Affichage principal
            if (loadingUser) {
                return <LoadingScreen message="Connexion √† votre profil..." />;
            }
            if (appError) {
                return <LoadingScreen message={`Erreur : ${appError}`} />;
            }
            if (!userData || !userData.name) {
                return <LoginScreen userId={user.uid} />;
            }

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col items-center">
                    <div className="w-full max-w-md mx-auto bg-white shadow-2xl rounded-b-3xl">
                        <Header userData={userData} />
                    </div>
                    
                    <main className="w-full max-w-md mx-auto p-4 pb-24">
                        {currentScreen === 'lecon' && <LessonScreen userData={userData} userId={user.uid} startQuiz={startQuiz} />}
                        {currentScreen === 'quiz' && <QuizScreen questions={quizQuestions} onComplete={completeDailyLesson} onBack={() => setCurrentScreen('lecon')} />}
                        {currentScreen === 'progres' && <ProgressScreen userData={userData} />}
                        {currentScreen === 'jeux' && <GameScreen />}
                        {currentScreen === 'dico' && <DictionaryScreen userData={userData} userId={user.uid} />}
                        {currentScreen === 'finance' && <FinanceScreen />}
                        {currentScreen === 'social' && <LeaderboardScreen />}
                    </main>

                    <BottomNavBar currentScreen={currentScreen} setCurrentScreen={setCurrentScreen} />
                </div>
            );
        }

        // D√©marrage de l'application
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>