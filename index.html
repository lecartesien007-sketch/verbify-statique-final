import React, { useState, useEffect, useMemo, useCallback } from 'react';

// --- IMPORTATIONS FIREBASE (NE PAS TOUCHER) ---
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { 
    getDatabase, 
    ref, 
    get, 
    set, 
    onValue, 
    update, 
    query, 
    orderByChild, 
    limitToLast 
} from "firebase/database";

// --- VOTRE CONFIGURATION FIREBASE (avec URL de la RTDB) ---
// C'est la "cl√©" qui connecte votre app √† votre base de donn√©es
const firebaseConfig = {
  apiKey: "AIzaSyCZQXRtEITaC7X5YJPH-VvfDuhzZYi1sSI",
  authDomain: "verbufy-by-bechir.firebaseapp.com",
  projectId: "verbufy-by-bechir",
  storageBucket: "verbufy-by-bechir.firebasestorage.app",
  messagingSenderId: "145432541455",
  appId: "1:145432541455:web:ba2ec858abc1619e48e67a",
  // L'URL est CRUCIALE. Elle est maintenant d√©finitivement fix√©e.
  databaseURL: "https://verbufy-by-bechir-default-rtdb.firebaseio.com" 
};

// --- INITIALISATION DE FIREBASE ---
// @ts-ignore : Ajout√© pour corriger l'erreur Vercel/TypeScript
let app, auth, db; 
try {
  app = initializeApp(firebaseConfig);
  // @ts-ignore
  auth = getAuth(app);
  // @ts-ignore
  db = getDatabase(app);
} catch (e) {
  console.error("Erreur d'initialisation de Firebase:", e);
  // Note: Nous ne pouvons pas utiliser alert() dans React, mais nous l'utilisons ici pour le d√©bogage de la connexion
  console.log("Erreur critique de connexion √† Firebase. V√©rifiez votre configuration.");
}

// --- BASE DE DONN√âES DES VERBES (pour les le√ßons) ---
const VERB_LIST = [
    { base: "be", past: "was/were", part: "been", fr: "√™tre" },
    { base: "have", past: "had", part: "had", fr: "avoir" },
    { base: "do", past: "did", part: "done", fr: "faire" },
    { base: "say", past: "said", part: "said", fr: "dire" },
    { base: "go", past: "went", part: "gone", fr: "aller" },
    { base: "get", past: "got", part: "got/gotten", fr: "obtenir" },
    { base: "make", past: "made", part: "made", fr: "faire/fabriquer" },
    { base: "know", past: "knew", part: "known", fr: "savoir" },
    { base: "think", past: "thought", part: "thought", fr: "penser" },
    { base: "take", past: "took", part: "taken", fr: "prendre" },
    { base: "see", past: "saw", part: "seen", fr: "voir" },
    { base: "come", past: "came", part: "come", fr: "venir" },
    { base: "want", past: "wanted", part: "wanted", fr: "vouloir" },
    { base: "look", past: "looked", part: "looked", fr: "regarder" },
    { base: "use", past: "used", part: "used", fr: "utiliser" },
    { base: "find", past: "found", part: "found", fr: "trouver" },
    { base: "give", past: "gave", part: "given", fr: "donner" },
    { base: "tell", past: "told", part: "told", fr: "dire (raconter)" },
    { base: "work", past: "worked", part: "worked", fr: "travailler" },
    { base: "call", past: "called", part: "called", fr: "appeler" },
];

const PHRASAL_VERBS = [
    { base: "look for", fr: "chercher", ex: "I'm looking for my keys." },
    { base: "get up", fr: "se lever", ex: "He gets up at 6 AM." },
    { base: "turn on", fr: "allumer", ex: "Please turn on the light." },
    { base: "turn off", fr: "√©teindre", ex: "Turn off the TV." },
    { base: "give up", fr: "abandonner", ex: "Don't give up!" },
    { base: "put on", fr: "mettre (v√™tement)", ex: "Put on your coat." },
];

const FINANCE_VERBS = [
    { base: "audit", fr: "auditer", ex: "The firm will audit our accounts." },
    { base: "leverage", fr: "utiliser un effet de levier", ex: "They leveraged their assets to buy the company." },
    { base: "hedge", fr: "couvrir (un risque)", ex: "He hedged his bets by investing in gold." },
    { base: "underwrite", fr: "souscrire / garantir", ex: "The bank agreed to underwrite the new share issue." },
    { base: "allocate", fr: "allouer", ex: "We need to allocate more resources to this project." },
    { base: "amortize", fr: "amortir", ex: "The loan will be amortized over 10 years." },
    { base: "invest", fr: "investir", ex: "She invests 20% of her salary." },
    { base: "liquidate", fr: "liquider", ex: "They had to liquidate their assets." },
    { base: "yield", fr: "rapporter / c√©der", ex: "The investment yields 5%." },
    { base: "forecast", fr: "pr√©voir", ex: "Analysts forecast a rise in profits." },
];


// =============================================
// --- LOGIQUE DE JEU ---
// =============================================

// Fonction pour g√©n√©rer une question de quiz √† partir d'un verbe
const createQuizQuestion = (verb) => {
    const type = Math.random() < 0.5 ? 'past' : 'part';
    const correct = type === 'past' ? verb.past.split('/')[0] : verb.part.split('/')[0];
    
    // G√©n√©rer 3 leurres (verbes al√©atoires diff√©rents)
    const allOptions = VERB_LIST.filter(v => v.base !== verb.base)
                                .sort(() => 0.5 - Math.random())
                                .slice(0, 3)
                                .map(v => type === 'past' ? v.past.split('/')[0] : v.part.split('/')[0]);
    
    // Ajouter la bonne r√©ponse et m√©langer
    const options = [...allOptions, correct].sort(() => 0.5 - Math.random());

    return {
        verb,
        type,
        questionText: `Quelle est la forme au ${type === 'past' ? 'pr√©t√©rit' : 'participe pass√©'} de "${verb.base}" (${verb.fr})?`,
        options,
        correctAnswer: correct
    };
};

// =============================================
// --- COMPOSANT PRINCIPAL DE L'APPLICATION ---
// =============================================
export default function App() {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState(null);
  const [loadingUser, setLoadingUser] = useState(true);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [appError, setAppError] = useState(null);
  const [currentScreen, setCurrentScreen] = useState('lecon'); // 'lecon', 'progres', 'jeux', 'dico', 'finance', 'social', 'quiz'

  // --- √âtape 1 : Authentification ---
  useEffect(() => {
    // @ts-ignore
    if (!auth) return;

    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        setUser(currentUser);
        await checkAndCreateUserData(currentUser.uid);
        setIsAuthReady(true);
      } else {
        try {
          signInAnonymously(auth);
        } catch (error) {
          console.error("Erreur de connexion anonyme:", error);
          setAppError("Impossible de se connecter au service. V√©rifiez votre connexion.");
        }
      }
    });
    return () => unsubscribe();
  }, []);

  // --- √âtape 2 : Cr√©ation/V√©rification des donn√©es utilisateur ---
  const checkAndCreateUserData = async (userId) => {
    const userRef = ref(db, `users/${userId}`);
    try {
      const snapshot = await get(userRef);
      if (!snapshot.exists()) {
        const newUserData = {
          name: "",
          xp: 0,
          streak: 0,
          lastCompleted: null,
          favorites: {},
          dailyVerbs: [],
          createdAt: new Date().toISOString(),
        };
        await set(userRef, newUserData);
      }
    } catch (error) {
      console.error("Erreur checkAndCreateUserData:", error);
      setAppError("Impossible de cr√©er le profil utilisateur.");
    }
  };

  // --- √âtape 3 : √âcoute en temps r√©el des donn√©es utilisateur ---
  useEffect(() => {
    if (!isAuthReady || !user) return;

    const userRef = ref(db, `users/${user.uid}`);
    const unsubscribe = onValue(userRef, (snapshot) => {
      if (snapshot.exists()) {
        setUserData(snapshot.val());
      } else {
        console.warn("Snapshot utilisateur inexistant.");
      }
      setLoadingUser(false);
    }, (error) => {
      console.error("Erreur onValue (userData):", error);
      setAppError("Impossible de synchroniser les donn√©es utilisateur.");
      setLoadingUser(false);
    });

    return () => unsubscribe();
  }, [isAuthReady, user]);

  // --- Logique du Quiz (G√©n√®re les questions quand on va sur l'√©cran Quiz) ---
  const [quizQuestions, setQuizQuestions] = useState([]);
  const startQuiz = useCallback(() => {
    if (userData.dailyVerbs && userData.dailyVerbs.length > 0) {
      const verbs = userData.dailyVerbs.map(base => VERB_LIST.find(v => v.base === base));
      const questions = verbs.map(v => createQuizQuestion(v));
      setQuizQuestions(questions);
      setCurrentScreen('quiz');
    }
  }, [userData]);

  // --- Fonction de Mise √† Jour de la Progression apr√®s Quiz ---
  const completeDailyLesson = async (xpGained) => {
    const today = new Date().toISOString();
    
    // Calcul de la s√©rie
    const lastDate = userData.lastCompleted ? new Date(userData.lastCompleted) : null;
    let newStreak = userData.streak || 0;
    
    if (lastDate) {
        const yesterday = new Date(new Date().setDate(new Date().getDate() - 1)).toDateString();
        // Si la derni√®re date de compl√©tion est hier, la s√©rie continue
        if (lastDate.toDateString() === yesterday) {
            newStreak += 1;
        } else if (lastDate.toDateString() !== new Date().toDateString()) {
            // Sinon, si ce n'est pas aujourd'hui, la s√©rie est r√©initialis√©e √† 1
            newStreak = 1;
        }
        // Si c'est d√©j√† aujourd'hui, ne rien faire
    } else {
        newStreak = 1; // Premi√®re le√ßon compl√©t√©e
    }

    const updates = {
      xp: (userData.xp || 0) + xpGained,
      streak: newStreak,
      lastCompleted: today,
      dailyVerbs: [], // R√©initialise les verbes du jour
    };
    
    await update(ref(db, `users/${user.uid}`), updates);
    setCurrentScreen('lecon'); // Retour √† l'√©cran de le√ßon
  };


  // --- Affichage principal ---
  if (loadingUser) {
    return <LoadingScreen message="Connexion √† votre profil..." />;
  }

  if (appError) {
    return <LoadingScreen message={`Erreur : ${appError}`} />;
  }

  // Si l'utilisateur n'a pas de nom, forcer l'√©cran de connexion
  if (!userData || !userData.name) {
    return <LoginScreen userId={user.uid} />;
  }

  // L'utilisateur est connect√© et a un nom, afficher l'application
  return (
    <div className="min-h-screen bg-gray-100 flex flex-col items-center">
      <div className="w-full max-w-md mx-auto bg-white shadow-2xl rounded-b-3xl">
        <Header userData={userData} />
      </div>
      
      <main className="w-full max-w-md mx-auto p-4 pb-24">
        {/* Navigation par onglets */}
        {currentScreen === 'lecon' && <LessonScreen userData={userData} userId={user.uid} startQuiz={startQuiz} />}
        {currentScreen === 'quiz' && <QuizScreen questions={quizQuestions} onComplete={completeDailyLesson} onBack={() => setCurrentScreen('lecon')} />}
        {currentScreen === 'progres' && <ProgressScreen userData={userData} />}
        {currentScreen === 'jeux' && <GameScreen />}
        {currentScreen === 'dico' && <DictionaryScreen userData={userData} userId={user.uid} />}
        {currentScreen === 'finance' && <FinanceScreen />}
        {currentScreen === 'social' && <LeaderboardScreen />}
      </main>

      <BottomNavBar currentScreen={currentScreen} setCurrentScreen={setCurrentScreen} />
    </div>
  );
}

// =============================================
// --- COMPOSANTS D'INTERFACE (UI) ---
// =============================================

const Header = React.memo(({ userData }) => (
  <header className="p-5 rounded-b-3xl" style={{background: 'linear-gradient(135deg, #4F46E5 0%, #818CF8 100%)'}}>
    <div className="flex justify-between items-center mb-2">
      <div>
        <h1 className="text-3xl font-bold text-white">Verbify</h1>
        <p className="text-sm text-indigo-200 -mt-1">created by Kone Mohamed Bechir</p>
      </div>
      <div className="flex gap-4">
        <div className="text-center">
          <div className="text-2xl text-white font-bold">{userData.xp || 0}</div>
          <div className="text-xs text-indigo-200">‚≠êÔ∏è XP</div>
        </div>
        <div className="text-center">
          <div className="text-2xl text-white font-bold">{userData.streak || 0}</div>
          <div className="text-xs text-indigo-200">üî• S√©rie</div>
        </div>
      </div>
    </div>
  </header>
));

const BottomNavBar = React.memo(({ currentScreen, setCurrentScreen }) => {
  const navItems = [
    { id: 'lecon', label: 'Le√ßon', icon: 'üéì' },
    { id: 'progres', label: 'Progr√®s', icon: 'üìä' },
    { id: 'jeux', label: 'Jeux', icon: 'üéÆ' },
    { id: 'dico', label: 'Dico', icon: 'üìö' },
    { id: 'finance', label: 'Finance', icon: 'üìà' },
    { id: 'social', label: 'Social', icon: 'üèÜ' },
  ];

  return (
    <nav className="fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto bg-white border-t border-gray-200 shadow-inner flex justify-around p-2">
      {navItems.map(item => (
        <button
          key={item.id}
          onClick={() => setCurrentScreen(item.id)}
          className={`flex flex-col items-center p-2 rounded-lg transition-all ${
            currentScreen === item.id ? 'bg-indigo-100 text-indigo-600' : 'text-gray-500 hover:text-indigo-500'
          }`}
        >
          <span className="text-2xl">{item.icon}</span>
          <span className="text-xs font-medium">{item.label}</span>
        </button>
      ))}
    </nav>
  );
});

const LoadingScreen = ({ message }) => (
  <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4 text-center">
    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mb-4"></div>
    <h1 className="text-2xl font-bold text-indigo-700">Verbify</h1>
    <p className="text-gray-600 mt-2">{message}</p>
  </div>
);

// =============================================
// --- √âCRAN DE CONNEXION (LOGIN) ---
// =============================================
function LoginScreen({ userId }) {
  const [name, setName] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  const saveName = async () => {
    if (name.length < 2) {
      setError("Veuillez entrer un nom d'au moins 2 caract√®res.");
      return;
    }
    setIsLoading(true);
    setError(null);
    try {
      const userRef = ref(db, `users/${userId}`);
      await update(userRef, { name: name });
      // L'√©couteur onValue dans App() s'occupera du changement d'√©cran
    } catch (err) {
      console.error("Erreur saveName:", err);
      setError("Impossible d'enregistrer le nom. R√©essayez.");
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4" style={{background: 'linear-gradient(135deg, #4F46E5 0%, #818CF8 100%)'}}>
      <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
        <div className="text-6xl mb-4">ü§ñ</div>
        <h1 className="text-3xl font-bold text-gray-800 mb-2">Bienvenue, √©l√®ves de la FCGE !</h1>
        <p className="text-base text-gray-600 mb-6">(Finance Compta Gestion d'Entreprise)</p>
        
        <p className="text-lg text-gray-700 mb-4">Comment devrions-nous vous appeler ?</p>
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="Entrez votre nom..."
          className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
        <button
          onClick={saveName}
          disabled={isLoading}
          className="w-full bg-indigo-600 text-white py-3 px-6 rounded-lg font-bold text-lg mt-6 hover:bg-indigo-700 transition-transform transform hover:scale-105 shadow-lg disabled:bg-gray-400 disabled:hover:scale-100 flex items-center justify-center"
        >
          {isLoading ? (
            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
          ) : (
            "Start Adventure"
          )}
        </button>
      </div>
    </div>
  );
}

// =============================================
// --- √âCRAN LE√áON ---
// =============================================
const LessonScreen = React.memo(({ userData, userId, startQuiz }) => {
  const [dailyVerbs, setDailyVerbs] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  const getDailyVerbs = useCallback(async () => {
    setIsLoading(true);
    const today = new Date().toDateString();
    
    // 1. L'utilisateur a-t-il d√©j√† termin√© aujourd'hui ?
    const lastCompletedDate = userData.lastCompleted ? new Date(userData.lastCompleted).toDateString() : null;
    if (lastCompletedDate === today) {
      setDailyVerbs([]); // Tableau vide signifie "termin√©"
      setIsLoading(false);
      return;
    }

    // 2. A-t-il des verbes d√©j√† assign√©s mais non termin√©s ?
    if (userData.dailyVerbs && userData.dailyVerbs.length === 5) {
      setDailyVerbs(userData.dailyVerbs.map(base => VERB_LIST.find(v => v.base === base)));
      setIsLoading(false);
      return;
    }

    // 3. Il n'a pas de verbes, nous devons en g√©n√©rer 5 nouveaux
    const learnedBases = Object.keys(userData.progress || {});
    const unlearnedVerbs = VERB_LIST.filter(verb => !learnedBases.includes(verb.base));
    
    const newVerbs = unlearnedVerbs
      .sort(() => 0.5 - Math.random()) // M√©langer
      .slice(0, 5); // Prendre les 5 premiers

    if (newVerbs.length < 5) {
        // L'utilisateur a presque tout appris, on recommence
        const allVerbsShuffled = [...VERB_LIST].sort(() => 0.5 - Math.random()).slice(0, 5);
        setDailyVerbs(allVerbsShuffled);
        await set(ref(db, `users/${userId}/dailyVerbs`), allVerbsShuffled.map(v => v.base));
    } else {
        setDailyVerbs(newVerbs);
        // Sauvegarder ces nouveaux verbes dans Firebase
        await set(ref(db, `users/${userId}/dailyVerbs`), newVerbs.map(v => v.base));
    }
    setIsLoading(false);
  }, [userData, userId]);

  useEffect(() => {
    getDailyVerbs();
  }, [getDailyVerbs]);


  return (
    <div className="space-y-6">
      <div className="bg-white p-6 rounded-2xl shadow-lg text-center">
        <h2 className="text-2xl font-bold mb-4">Votre le√ßon du jour</h2>
        <p className="text-gray-600 mb-4">
          Pr√™t pour votre le√ßon du jour ? N'oubliez pas de viser la s√©rie !
        </p>
        
        {isLoading && <p className="text-gray-500">Chargement des verbes...</p>}
        
        {!isLoading && dailyVerbs.length === 0 && (
          <div className="bg-green-100 p-4 rounded-lg">
            <h3 className="text-xl font-bold text-green-700">Le√ßon termin√©e ! üéâ</h3>
            <p className="text-green-600">Excellent travail. Revenez demain pour 5 nouveaux verbes !</p>
          </div>
        )}

        {!isLoading && dailyVerbs.length > 0 && (
          <>
            <p className="text-gray-600 mb-4">Pr√™t √† apprendre ces 5 nouveaux verbes ?</p>
            <div className="flex flex-wrap gap-2 justify-center mb-6">
              {dailyVerbs.map(verb => (
                <span key={verb.base} className="bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full">
                  {verb.base}
                </span>
              ))}
            </div>
            <button
              onClick={startQuiz}
              className="w-full bg-green-500 text-white py-3 px-6 rounded-lg font-bold text-lg hover:bg-green-600 transition-transform transform hover:scale-105 shadow-md"
            >
              Commencer le Quiz (+10 XP)
            </button>
          </>
        )}
      </div>
    </div>
  );
});

// =============================================
// --- √âCRAN QUIZ ---
// =============================================
function QuizScreen({ questions, onComplete, onBack }) {
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [score, setScore] = useState(0);
    const [feedback, setFeedback] = useState(null);
    const [showResults, setShowResults] = useState(false);

    const currentQuestion = questions[currentQuestionIndex];

    const handleAnswer = (selectedAnswer) => {
        if (feedback) return; // Emp√™cher la double r√©ponse
        
        const isCorrect = selectedAnswer === currentQuestion.correctAnswer;
        
        if (isCorrect) {
            setScore(s => s + 1);
            setFeedback('‚úÖ Correct !');
        } else {
            setFeedback(`‚ùå Faux. La bonne r√©ponse √©tait "${currentQuestion.correctAnswer}"`);
        }

        // Passer √† la question suivante apr√®s un court d√©lai
        setTimeout(() => {
            setFeedback(null);
            if (currentQuestionIndex < questions.length - 1) {
                setCurrentQuestionIndex(i => i + 1);
            } else {
                setShowResults(true);
            }
        }, 1500);
    };
    
    // Affichage des r√©sultats et r√©compenses
    if (showResults) {
        const xpGained = score >= 3 ? 10 : 0;
        const resultMessage = score >= 3 ? "Super ! Vous avez r√©ussi le quiz et gagnez 10 XP." : "Oups. Entra√Ænez-vous encore et revenez demain. (0 XP)";
        
        // Mettre √† jour Firebase une seule fois lors de l'affichage des r√©sultats
        useEffect(() => {
            if (score >= 3) {
                onComplete(xpGained);
            } else {
                onBack(); // Retour √† la le√ßon sans r√©compense
            }
        }, [onComplete, onBack, score, xpGained]);

        return (
            <div className="bg-white p-6 rounded-2xl shadow-lg text-center">
                <h2 className="text-3xl font-bold mb-4">{score >= 3 ? "Bravo !" : "Entra√Ænez-vous !"}</h2>
                <p className="text-xl mb-4">Votre score : {score} / {questions.length}</p>
                <p className={`text-lg font-semibold ${score >= 3 ? 'text-green-600' : 'text-red-600'}`}>{resultMessage}</p>
                <button onClick={onBack} className="mt-6 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700">
                    Retour √† l'accueil
                </button>
            </div>
        );
    }
    
    if (!currentQuestion) return <LoadingScreen message="Pr√©paration du quiz..." />;

    return (
        <div className="bg-white p-6 rounded-2xl shadow-lg">
            <button onClick={onBack} className="text-indigo-600 mb-4 text-lg">&larr; Quitter le Quiz</button>
            <div className="text-center">
                <p className="text-sm text-gray-500 mb-2">Question {currentQuestionIndex + 1} / {questions.length}</p>
                <div className="bg-indigo-50 p-6 rounded-xl mb-6">
                    <h3 className="text-xl font-semibold text-indigo-800">{currentQuestion.questionText}</h3>
                </div>
                
                {currentQuestion.options.map((option, index) => (
                    <button
                        key={index}
                        onClick={() => handleAnswer(option)}
                        disabled={!!feedback}
                        className={`w-full py-3 px-4 mb-3 rounded-lg font-medium text-lg border-2 transition-all ${
                            feedback && option === currentQuestion.correctAnswer
                                ? 'bg-green-100 border-green-500'
                                : feedback && option !== currentQuestion.correctAnswer && option === selectedAnswer
                                ? 'bg-red-100 border-red-500'
                                : 'bg-gray-100 border-gray-300 hover:bg-gray-200'
                        }`}
                    >
                        {option}
                    </button>
                ))}
                
                {feedback && (
                    <p className={`mt-4 text-xl font-bold ${feedback.startsWith('‚úÖ') ? 'text-green-600' : 'text-red-600'}`}>
                        {feedback}
                    </p>
                )}
            </div>
        </div>
    );
}
// Note: Utilisation d'une variable pour simuler selectedAnswer pour le style de feedback
const selectedAnswer = null; // Placeholder

// =============================================
// --- √âCRAN PROGR√àS (CALENDRIER) ---
// =============================================
const ProgressScreen = React.memo(({ userData }) => {
  const [currentDate] = useState(new Date());

  const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
  const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
  const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);
  const emptyDays = Array.from({ length: (firstDayOfMonth + 6) % 7 }); // Ajustement pour Lundi premier jour

  const lastCompletedDate = userData.lastCompleted ? new Date(userData.lastCompleted).toDateString() : null;
  const today = new Date().toDateString();

  return (
    <div className="bg-white p-6 rounded-2xl shadow-lg">
      <h2 className="text-2xl font-bold text-center mb-4">Mon Progr√®s</h2>
      <div className="text-center mb-4">
        <h3 className="text-xl font-semibold">{currentDate.toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}</h3>
      </div>
      <div className="grid grid-cols-7 gap-2 text-center">
        {['Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa', 'Di'].map(day => (
          <div key={day} className="font-bold text-gray-500 text-sm">{day}</div>
        ))}
        {emptyDays.map((_, i) => (
          <div key={`empty-${i}`}></div>
        ))}
        {daysArray.map(day => {
          const dateToCheck = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
          const isToday = dateToCheck.toDateString() === today;
          // Logique simplifi√©e pour l'affichage de la compl√©tion bas√©e sur la derni√®re date
          const isCompleted = lastCompletedDate === dateToCheck.toDateString();
          
          let dayClass = "w-10 h-10 flex items-center justify-center rounded-full";
          if (isCompleted || (isToday && lastCompletedDate === today)) {
            dayClass += " bg-green-500 text-white font-bold";
          } else if (isToday) {
            dayClass += " bg-indigo-100 text-indigo-600 font-bold";
          } else {
            dayClass += " text-gray-700";
          }
          
          return (
            <div key={day} className={dayClass}>
              {day}
            </div>
          );
        })}
      </div>
      <div className="mt-8 p-4 bg-indigo-50 rounded-lg text-center">
        <p className="text-indigo-800 font-semibold">S√©rie de Jours Actuelle : {userData.streak || 0} üî•</p>
      </div>
    </div>
  );
});

// =============================================
// --- √âCRAN JEUX ---
// =============================================
const GameScreen = React.memo(() => {
  const [currentGame, setCurrentGame] = useState(null);

  const games = [
    { id: 'truefalse', label: 'Vrai ou Faux', icon: '‚ùì', description: 'Le pr√©t√©rit de "go" est "went" ?' },
    { id: 'writing', label: '√âcriture', icon: '‚úçÔ∏è', description: '√âcrivez les 3 formes du verbe.' },
    { id: 'test', label: 'Test de Vitesse', icon: '‚ö°Ô∏è', description: 'Bient√¥t disponible !' },
  ];

  if (currentGame) {
    if (currentGame === 'truefalse') return <GameTrueFalse onBack={() => setCurrentGame(null)} />;
    if (currentGame === 'writing') return <GameWriting onBack={() => setCurrentGame(null)} />;
    // ... autres jeux
  }

  return (
    <div className="space-y-4">
      <h2 className="text-2xl font-bold text-center mb-4">Mini-Jeux</h2>
      {games.map(game => (
        <button
          key={game.id}
          onClick={() => game.id !== 'test' ? setCurrentGame(game.id) : console.log('Jeu √† venir')}
          disabled={game.id === 'test'}
          className="w-full bg-white p-5 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:hover:scale-100"
        >
          <div className="text-4xl p-3 bg-gray-100 rounded-lg">{game.icon}</div>
          <div>
            <h3 className="text-xl font-bold text-gray-800">{game.label}</h3>
            <p className="text-gray-500">{game.description}</p>
          </div>
        </button>
      ))}
    </div>
  );
});

// --- Jeu 1 : Vrai ou Faux ---
function GameTrueFalse({ onBack }) {
  const [question, setQuestion] = useState(null);
  const [score, setScore] = useState(0);

  const generateQuestion = useCallback(() => {
    const verb = VERB_LIST[Math.floor(Math.random() * VERB_LIST.length)];
    const isTrue = Math.random() > 0.5;
    let falsePast;
    if (!isTrue) {
      falsePast = VERB_LIST[Math.floor(Math.random() * VERB_LIST.length)].past;
      while (falsePast === verb.past) {
        falsePast = VERB_LIST[Math.floor(Math.random() * VERB_LIST.length)].past;
      }
    }
    setQuestion({
      verb,
      displayPast: isTrue ? verb.past : falsePast,
      isTrue,
    });
  }, []);

  useEffect(generateQuestion, [generateQuestion]);

  const handleAnswer = (answer) => {
    if ((answer && question.isTrue) || (!answer && !question.isTrue)) {
      setScore(s => s + 1);
      // Feedback correct (non impl√©ment√©)
    } else {
      setScore(0);
      // Feedback incorrect (non impl√©ment√©)
    }
    generateQuestion();
  };

  if (!question) return <LoadingScreen message="Chargement du jeu..." />;

  return (
    <div className="bg-white p-6 rounded-2xl shadow-lg">
      <button onClick={onBack} className="text-indigo-600 mb-4">&larr; Retour aux jeux</button>
      <div className="text-center">
        <h3 className="text-xl font-bold mb-2">Vrai ou Faux ?</h3>
        <p className="text-lg text-gray-600 mb-6">Score actuel : {score}</p>
        <div className="bg-gray-100 p-8 rounded-lg mb-6">
          <p className="text-2xl">Le pr√©t√©rit de <strong className="text-indigo-600">{question.verb.base}</strong></p>
          <p className="text-2xl">est</p>
          <p className="text-4xl font-bold mt-2">{question.displayPast}</p>
        </div>
        <div className="flex justify-around">
          <button onClick={() => handleAnswer(true)} className="bg-green-500 text-white font-bold py-3 px-10 rounded-lg text-xl hover:bg-green-600">Vrai</button>
          <button onClick={() => handleAnswer(false)} className="bg-red-500 text-white font-bold py-3 px-10 rounded-lg text-xl hover:bg-red-600">Faux</button>
        </div>
      </div>
    </div>
  );
}

// --- Jeu 2 : √âcriture ---
function GameWriting({ onBack }) {
  const [verb, setVerb] = useState(null);
  const [past, setPast] = useState('');
  const [part, setPart] = useState('');
  const [message, setMessage] = useState('');
  const [score, setScore] = useState(0);

  const newVerb = useCallback(() => {
    setVerb(VERB_LIST[Math.floor(Math.random() * VERB_LIST.length)]);
    setPast('');
    setPart('');
    setMessage('');
  }, []);

  useEffect(newVerb, [newVerb]);

  const checkAnswer = () => {
    const isPastCorrect = verb.past.split('/').includes(past.trim().toLowerCase());
    const isPartCorrect = verb.part.split('/').includes(part.trim().toLowerCase());

    if (isPastCorrect && isPartCorrect) {
      setMessage('Parfait ! Verbe suivant.');
      setScore(s => s + 1);
      setTimeout(newVerb, 1500);
    } else {
      setMessage(`Oups ! ${!isPastCorrect ? 'Pr√©t√©rit ' : ''} ${!isPartCorrect ? 'Participe ' : ''} incorrect.`);
    }
  };

  if (!verb) return <LoadingScreen message="Chargement..." />;

  return (
    <div className="bg-white p-6 rounded-2xl shadow-lg">
      <button onClick={onBack} className="text-indigo-600 mb-4">&larr; Retour aux jeux</button>
      <div className="text-center">
        <h3 className="text-xl font-bold mb-2">Jeu d'√âcriture</h3>
        <p className="text-lg text-gray-600 mb-6">Score : {score}</p>
        
        <div className="bg-gray-100 p-8 rounded-lg mb-6">
          <p className="text-2xl">√âcrivez les formes de :</p>
          <p className="text-4xl font-bold mt-2 text-indigo-600">{verb.base} ({verb.fr})</p>
        </div>
        
        <div className="space-y-4">
          <input
            type="text"
            value={past}
            onChange={(e) => setPast(e.target.value)}
            placeholder="Pr√©t√©rit (ex: went)"
            className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <input
            type="text"
            value={part}
            onChange={(e) => setPart(e.target.value)}
            placeholder="Participe Pass√© (ex: gone)"
            className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
        </div>
        
        <button onClick={checkAnswer} className="w-full bg-green-500 text-white font-bold py-3 px-10 rounded-lg text-xl hover:bg-green-600 mt-6">
          Valider
        </button>
        {message && <p className="text-lg mt-4">{message}</p>}
      </div>
    </div>
  );
}


// =============================================
// --- √âCRAN DICTIONNAIRE ---
// =============================================
const DictionaryScreen = React.memo(({ userData, userId }) => {
  const [tab, setTab] = useState('verbs'); // 'verbs' ou 'phrasal'
  const [searchTerm, setSearchTerm] = useState('');
  const [apiResult, setApiResult] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);

  const favorites = useMemo(() => userData.favorites || {}, [userData.favorites]);

  const handleSearch = async (e) => {
    e.preventDefault();
    if (searchTerm.length < 2) return;
    
    setIsLoading(true);
    setApiResult(null);
    setError(null);
    
    try {
      const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${searchTerm}`);
      if (!response.ok) {
        throw new Error('Mot non trouv√©.');
      }
      const data = await response.json();
      setApiResult(data[0]);
    } catch (err) {
      setError(err.message);
    }
    setIsLoading(false);
  };

  const toggleFavorite = async (verbBase) => {
    const newFavorites = { ...favorites };
    if (newFavorites[verbBase]) {
      delete newFavorites[verbBase];
    } else {
      newFavorites[verbBase] = true;
    }
    // @ts-ignore
    await update(ref(db, `users/${userId}`), { favorites: newFavorites });
  };
  
  const playAudio = (audioUrl) => {
    if (audioUrl) {
      new Audio(audioUrl).play();
    } else {
      // Fallback si pas d'audio, utilise la synth√®se vocale
      const utterance = new SpeechSynthesisUtterance(apiResult.word);
      utterance.lang = 'en-US';
      speechSynthesis.speak(utterance);
    }
  };

  return (
    <div className="space-y-4">
      <h2 className="text-2xl font-bold text-center mb-4">Dictionnaire</h2>
      <div className="flex border-b">
        <button onClick={() => setTab('verbs')} className={`flex-1 p-3 font-bold ${tab === 'verbs' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-500'}`}>
          Verbes
        </button>
        <button onClick={() => setTab('phrasal')} className={`flex-1 p-3 font-bold ${tab === 'phrasal' ? 'border-b-4 border-indigo-600 text-indigo-600' : 'text-gray-500'}`}>
          Verbes √† Particule
        </button>
      </div>

      <form onSubmit={handleSearch} className="flex gap-2">
        <input
          type="text"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          placeholder="Rechercher un mot anglais..."
          className="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
        />
        <button type="submit" className="bg-indigo-600 text-white p-3 rounded-lg text-2xl">üîç</button>
      </form>

      {/* --- Onglet Verbes (R√©sultats API) --- */}
      {tab === 'verbs' && (
        <div className="space-y-4">
          {isLoading && <p>Recherche en cours...</p>}
          {error && <p className="text-red-500">{error}</p>}
          {apiResult && (
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <div className="flex justify-between items-center mb-2">
                <h3 className="text-3xl font-bold">{apiResult.word}</h3>
                <button onClick={() => toggleFavorite(apiResult.word)} className="text-3xl">
                  {favorites[apiResult.word] ? '‚≠êÔ∏è' : '‚òÜ'}
                </button>
              </div>
              <div className="flex items-center gap-2 mb-4">
                 <p className="text-lg text-gray-600">{apiResult.phonetic || (apiResult.phonetics[0]?.text)}</p>
                 <button onClick={() => playAudio(apiResult.phonetics.find(p => p.audio)?.audio)} className="text-2xl">üîä</button>
              </div>
             
              {apiResult.meanings.map((meaning, index) => (
                <div key={index} className="mt-4">
                  <h4 className="text-xl font-semibold italic text-indigo-600">{meaning.partOfSpeech}</h4>
                  {meaning.definitions.slice(0, 2).map((def, i) => (
                    <div key={i} className="mt-2 pl-4 border-l-4 border-gray-200">
                      <p className="text-gray-700">{def.definition}</p>
                      {def.example && <p className="text-gray-500 italic mt-1">"{def.example}"</p>}
                    </div>
                  ))}
                </div>
              ))}
               <AiExampleGenerator word={apiResult.word} />
            </div>
          )}
        </div>
      )}

      {/* --- Onglet Verbes √† Particule --- */}
      {tab === 'phrasal' && (
        <div className="bg-white p-6 rounded-2xl shadow-lg space-y-4">
          {PHRASAL_VERBS.filter(v => v.base.includes(searchTerm.toLowerCase())).map(verb => (
            <div key={verb.base}>
              <h3 className="text-xl font-bold">{verb.base}</h3>
              <p className="text-gray-600">{verb.fr}</p>
              <p className="text-gray-500 italic">"{verb.ex}"</p>
            </div>
          ))}
        </div>
      )}
    </div>
  );
});

// --- G√©n√©rateur d'exemples IA (dans le Dictionnaire) ---
function AiExampleGenerator({ word }) {
  const [examples, setExamples] = useState([]);
  const [isLoading, setIsLoading] = useState(false);

  const fetchExamples = async () => {
    setIsLoading(true);
    setExamples([]);
    
    const systemPrompt = "Act as a helpful English teacher. The user will give you a verb. Provide 3 new and distinct example sentences using this verb. Only return a JSON array of strings.";
    const userQuery = `G√©n√©rez 3 phrases pour le verbe : "${word}"`;
    const apiKey = ""; // Laiss√©e vide, g√©r√©e par l'environnement
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const payload = {
      contents: [{ parts: [{ text: userQuery }] }],
      systemInstruction: {
        parts: [{ text: systemPrompt }]
      },
      generationConfig: {
        responseMimeType: "application/json",
      }
    };

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      const text = result.candidates[0].content.parts[0].text;
      setExamples(JSON.parse(text));
    } catch (err) {
      console.error("Erreur API Gemini:", err);
      setExamples(["Erreur lors de la g√©n√©ration des phrases."]);
    }
    setIsLoading(false);
  };

  return (
    <div className="mt-6">
      <button 
        onClick={fetchExamples} 
        disabled={isLoading}
        className="flex items-center justify-center gap-2 w-full bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200"
      >
        {isLoading ? (
          <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-indigo-700"></div>
        ) : (
          "‚ú® G√©n√©rer des exemples (IA)"
        )}
      </button>
      {examples.length > 0 && (
        <ul className="list-disc list-inside mt-4 space-y-2">
          {examples.map((ex, i) => <li key={i} className="text-gray-700 italic">{ex}</li>)}
        </ul>
      )}
    </div>
  );
}

// =============================================
// --- √âCRAN FINANCE (IA) ---
// =============================================
const FinanceScreen = React.memo(() => {
  const [question, setQuestion] = useState(null);
  const [answer, setAnswer] = useState('');
  const [feedback, setFeedback] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const generateDrill = async () => {
    setIsLoading(true);
    setFeedback('');
    setAnswer('');
    
    const verb = FINANCE_VERBS[Math.floor(Math.random() * FINANCE_VERBS.length)];
    const systemPrompt = "Act as a finance professor. Create a simple fill-in-the-blank question using the verb I provide. The answer should be the verb itself (any tense). Only return a JSON object with 'question' and 'answer' properties.";
    const userQuery = `Verbe : "${verb.base}" (${verb.fr})`;
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    const payload = {
      contents: [{ parts: [{ text: userQuery }] }],
      systemInstruction: {
        parts: [{ text: systemPrompt }]
      },
      generationConfig: {
        responseMimeType: "application/json",
      }
    };

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      const text = result.candidates[0].content.parts[0].text;
      setQuestion(JSON.parse(text));
    } catch (err) {
      console.error("Erreur API Gemini (Finance):", err);
      setQuestion({ question: "Erreur de g√©n√©ration", answer: "" });
    }
    setIsLoading(false);
  };
  
  const checkFinanceAnswer = () => {
    if (answer.toLowerCase().trim() === question.answer.toLowerCase().trim()) {
      setFeedback('Correct ! üéâ');
    } else {
      setFeedback(`Oups ! La bonne r√©ponse √©tait "${question.answer}".`);
    }
  };

  return (
    <div className="bg-white p-6 rounded-2xl shadow-lg text-center">
      <h2 className="text-2xl font-bold mb-4">AI-Drill : Finance üìà</h2>
      <p className="text-gray-600 mb-6">Testez vos connaissances sur les verbes financiers avec l'IA.</p>
      
      <button onClick={generateDrill} disabled={isLoading} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 mb-6">
        {isLoading ? "G√©n√©ration..." : "G√©n√©rer un test"}
      </button>

      {question && (
        <div className="mt-4">
          <p className="text-xl text-gray-700 mb-4">{question.question.replace(question.answer, "_______")}</p>
          <input
            type="text"
            value={answer}
            onChange={(e) => setAnswer(e.target.value)}
            placeholder="Votre r√©ponse..."
            className="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
          <button onClick={checkFinanceAnswer} className="w-full bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 mt-4">
            Valider
          </button>
          {feedback && <p className="text-lg mt-4">{feedback}</p>}
        </div>
      )}
    </div>
  );
});


// =============================================
// --- √âCRAN SOCIAL (CLASSEMENT) ---
// =============================================
const LeaderboardScreen = React.memo(() => {
  const [leaderboard, setLeaderboard] = useState([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    const usersRef = ref(db, 'users');
    // Nous trions par XP (orderByChild) et prenons les 10 derniers (limitToLast), car Firebase trie par ordre croissant
    const topUsersQuery = query(usersRef, orderByChild('xp'), limitToLast(10));

    const unsubscribe = onValue(topUsersQuery, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        const sortedUsers = Object.values(data)
          .sort((a, b) => b.xp - a.xp); // Trier par ordre d√©croissant
        setLeaderboard(sortedUsers);
      }
      setIsLoading(false);
    }, (error) => {
      console.error("Erreur classement:", error);
      setIsLoading(false);
    });

    return () => unsubscribe();
  }, []);

  return (
    <div className="bg-white p-6 rounded-2xl shadow-lg">
      <h2 className="text-2xl font-bold text-center mb-6">Classement üèÜ</h2>
      {isLoading ? (
        <p>Chargement du classement...</p>
      ) : (
        <ol className="space-y-4">
          {leaderboard.map((user, index) => (
            <li key={user.name + index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-3">
                <span className="text-lg font-bold w-6">
                  {index === 0 && 'ü•á'}
                  {index === 1 && 'ü•à'}
                  {index === 2 && 'ü•â'}
                  {index > 2 && `${index + 1}.`}
                </span>
                <span className="text-lg font-semibold">{user.name}</span>
              </div>
              <span className="text-lg font-bold text-indigo-600">{user.xp} XP</span>
            </li>
          ))}
        </ol>
      )}
    </div>
  );
});
